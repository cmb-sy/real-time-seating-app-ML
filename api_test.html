<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API接続テスト</title>
    <style>
      body {
        font-family: "Helvetica Neue", Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      h1 {
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
      button {
        background-color: #4caf50;
        border: none;
        color: white;
        padding: 10px 15px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 10px 5px;
        cursor: pointer;
        border-radius: 4px;
      }
      button:hover {
        background-color: #45a049;
      }
      .result {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        margin-top: 15px;
        overflow-x: auto;
        max-height: 300px;
      }
      .error {
        color: #d8000c;
        background-color: #ffd2d2;
      }
      .success {
        color: #4f8a10;
        background-color: #dff2bf;
      }
      .loading {
        color: #9f6000;
        background-color: #feefb3;
      }
      #urlInput {
        width: 80%;
        padding: 10px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <h1>API接続テスト (更新版)</h1>

    <div>
      <label for="urlInput">APIベースURL:</label>
      <input
        type="text"
        id="urlInput"
        value="https://real-time-seating-app-ml.vercel.app"
      />
    </div>

    <div>
      <h3>基本エンドポイント</h3>
      <button onclick="testEndpoint('/api')">ルート情報</button>
      <button onclick="testEndpoint('/api/health')">ヘルスチェック</button>
    </div>

    <div>
      <h3>予測エンドポイント</h3>
      <button onclick="testEndpoint('/api/predictions/today-tomorrow')">
        今日・明日の予測
      </button>
      <button onclick="testEndpoint('/api/predictions/weekly-average')">
        週間平均予測
      </button>
    </div>

    <div>
      <h3>CORSテスト</h3>
      <button onclick="testWithOptions('/api/health')">
        CORSプリフライトテスト
      </button>
      <button onclick="testWithNoCredentials('/api/health')">
        credentials:omitテスト
      </button>
    </div>

    <h3>レスポンス結果:</h3>
    <div id="result" class="result">結果がここに表示されます</div>

    <script>
      // 基本的なAPIエンドポイントテスト
      async function testEndpoint(endpoint) {
        const resultDiv = document.getElementById("result");
        const baseUrl = document.getElementById("urlInput").value;
        const url = `${baseUrl}${endpoint}`;

        resultDiv.innerHTML = `<p class="loading">リクエスト中: ${url}...</p>`;

        try {
          const response = await fetch(url, {
            method: "GET",
            headers: {
              Accept: "application/json",
              "Content-Type": "application/json",
              Origin: window.location.origin,
            },
            credentials: "omit",
          });

          if (!response.ok) {
            throw new Error(
              `HTTP error! status: ${response.status} ${response.statusText}`
            );
          }

          const data = await response.json();

          resultDiv.innerHTML = `
          <p class="success">成功! エンドポイント: ${endpoint}</p>
          <p>ステータス: ${response.status}</p>
          <p>レスポンスヘッダー:</p>
          <pre>${formatHeaders(response.headers)}</pre>
          <p>レスポンスデータ:</p>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
        } catch (error) {
          resultDiv.innerHTML = `
          <p class="error">エラー! エンドポイント: ${endpoint}</p>
          <p>エラー詳細: ${error.message}</p>
        `;
        }
      }

      // CORSプリフライトテスト
      async function testWithOptions(endpoint) {
        const resultDiv = document.getElementById("result");
        const baseUrl = document.getElementById("urlInput").value;
        const url = `${baseUrl}${endpoint}`;

        resultDiv.innerHTML = `<p class="loading">OPTIONSリクエスト中: ${url}...</p>`;

        try {
          const response = await fetch(url, {
            method: "OPTIONS",
            headers: {
              "Access-Control-Request-Method": "GET",
              "Access-Control-Request-Headers": "Content-Type, Authorization",
              Origin: window.location.origin,
            },
          });

          resultDiv.innerHTML = `
          <p class="success">OPTIONSリクエスト成功!</p>
          <p>ステータス: ${response.status}</p>
          <p>レスポンスヘッダー:</p>
          <pre>${formatHeaders(response.headers)}</pre>
        `;
        } catch (error) {
          resultDiv.innerHTML = `
          <p class="error">OPTIONSリクエストエラー!</p>
          <p>エラー詳細: ${error.message}</p>
        `;
        }
      }

      // credentials:omitテスト
      async function testWithNoCredentials(endpoint) {
        const resultDiv = document.getElementById("result");
        const baseUrl = document.getElementById("urlInput").value;
        const url = `${baseUrl}${endpoint}`;

        resultDiv.innerHTML = `<p class="loading">credentials:omitでリクエスト中: ${url}...</p>`;

        try {
          const response = await fetch(url, {
            method: "GET",
            headers: {
              Accept: "application/json",
              "Content-Type": "application/json",
              Origin: window.location.origin,
            },
            credentials: "omit",
          });

          if (!response.ok) {
            throw new Error(
              `HTTP error! status: ${response.status} ${response.statusText}`
            );
          }

          const data = await response.json();

          resultDiv.innerHTML = `
          <p class="success">credentials:omitテスト成功!</p>
          <p>ステータス: ${response.status}</p>
          <p>レスポンスヘッダー:</p>
          <pre>${formatHeaders(response.headers)}</pre>
          <p>レスポンスデータ:</p>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
        } catch (error) {
          resultDiv.innerHTML = `
          <p class="error">credentials:omitテストエラー!</p>
          <p>エラー詳細: ${error.message}</p>
        `;
        }
      }

      // ヘッダーのフォーマット
      function formatHeaders(headers) {
        let result = "";
        for (const [key, value] of headers.entries()) {
          result += `${key}: ${value}\n`;
        }
        return result;
      }
    </script>
  </body>
</html>
