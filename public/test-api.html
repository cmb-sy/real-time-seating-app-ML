<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API エンドポイント テスト</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      button {
        background: #0070f3;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0051a2;
      }
      .result {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin-top: 10px;
        white-space: pre-wrap;
        font-family: monospace;
        max-height: 400px;
        overflow-y: auto;
      }
      .error {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }
      .success {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
      }
      .endpoint {
        margin-bottom: 15px;
        padding: 10px;
        border-left: 4px solid #0070f3;
        background: #f8f9fa;
      }
    </style>
  </head>
  <body>
    <h1>🚀 リアルタイム座席アプリ API テスト</h1>

    <div class="container">
      <h2>📋 利用可能なエンドポイント</h2>

      <div class="endpoint">
        <h3>1. ヘルスチェック</h3>
        <p><strong>URL:</strong> /health または /api/health</p>
        <button onclick="testEndpoint('/health', 'health-result')">
          ルートレベルでテスト
        </button>
        <button onclick="testEndpoint('/api/health', 'health-result-api')">
          APIレベルでテスト
        </button>
        <div id="health-result" class="result" style="display: none"></div>
        <div id="health-result-api" class="result" style="display: none"></div>
      </div>

      <div class="endpoint">
        <h3>2. 今日・明日の予測</h3>
        <p>
          <strong>URL:</strong> /predictions/today-tomorrow または
          /api/predictions/today-tomorrow
        </p>
        <button
          onclick="testEndpoint('/predictions/today-tomorrow', 'today-result')"
        >
          ルートレベルでテスト
        </button>
        <button
          onclick="testEndpoint('/api/predictions/today-tomorrow', 'today-result-api')"
        >
          APIレベルでテスト
        </button>
        <div id="today-result" class="result" style="display: none"></div>
        <div id="today-result-api" class="result" style="display: none"></div>
      </div>

      <div class="endpoint">
        <h3>3. 週間平均予測</h3>
        <p>
          <strong>URL:</strong> /predictions/weekly-average または
          /api/predictions/weekly-average
        </p>
        <button
          onclick="testEndpoint('/predictions/weekly-average', 'weekly-result')"
        >
          ルートレベルでテスト
        </button>
        <button
          onclick="testEndpoint('/api/predictions/weekly-average', 'weekly-result-api')"
        >
          APIレベルでテスト
        </button>
        <div id="weekly-result" class="result" style="display: none"></div>
        <div id="weekly-result-api" class="result" style="display: none"></div>
      </div>

      <div class="endpoint">
        <h3>4. Supabase連携</h3>
        <p><strong>URL:</strong> /supabase/sync または /api/supabase/sync</p>
        <button
          onclick="testEndpoint('/supabase/sync?type=current', 'supabase-result')"
        >
          現在の状況
        </button>
        <button
          onclick="testEndpoint('/api/supabase/sync?type=predictions', 'supabase-result-api')"
        >
          予測データ
        </button>
        <div id="supabase-result" class="result" style="display: none"></div>
        <div
          id="supabase-result-api"
          class="result"
          style="display: none"
        ></div>
      </div>
    </div>

    <div class="container">
      <h2>🔧 全エンドポイント一括テスト</h2>
      <button onclick="testAllEndpoints()">全てのエンドポイントをテスト</button>
      <div id="all-results" class="result" style="display: none"></div>
    </div>

    <script>
      const BASE_URL = window.location.origin;

      async function testEndpoint(endpoint, resultId) {
        const resultDiv = document.getElementById(resultId);
        resultDiv.style.display = "block";
        resultDiv.className = "result";
        resultDiv.textContent = "🔄 テスト中...";

        try {
          const startTime = Date.now();
          const response = await fetch(`${BASE_URL}${endpoint}`);
          const endTime = Date.now();
          const responseTime = endTime - startTime;

          const data = await response.json();

          resultDiv.className = response.ok ? "result success" : "result error";
          resultDiv.textContent = `✅ ステータス: ${response.status} ${
            response.statusText
          }
⏱️ レスポンス時間: ${responseTime}ms
📄 レスポンス:
${JSON.stringify(data, null, 2)}`;
        } catch (error) {
          resultDiv.className = "result error";
          resultDiv.textContent = `❌ エラー: ${error.message}
🔗 URL: ${BASE_URL}${endpoint}
📝 詳細: ネットワークエラーまたはCORSエラーの可能性があります`;
        }
      }

      async function testAllEndpoints() {
        const resultDiv = document.getElementById("all-results");
        resultDiv.style.display = "block";
        resultDiv.className = "result";
        resultDiv.textContent = "🔄 全エンドポイントをテスト中...";

        const endpoints = [
          "/health",
          "/api/health",
          "/predictions/today-tomorrow",
          "/api/predictions/today-tomorrow",
          "/predictions/weekly-average",
          "/api/predictions/weekly-average",
          "/supabase/sync?type=current",
          "/api/supabase/sync?type=current",
        ];

        let results = [];

        for (const endpoint of endpoints) {
          try {
            const startTime = Date.now();
            const response = await fetch(`${BASE_URL}${endpoint}`);
            const endTime = Date.now();
            const responseTime = endTime - startTime;

            results.push({
              endpoint,
              status: response.status,
              statusText: response.statusText,
              responseTime,
              success: response.ok,
            });
          } catch (error) {
            results.push({
              endpoint,
              status: "ERROR",
              statusText: error.message,
              responseTime: 0,
              success: false,
            });
          }
        }

        const successCount = results.filter((r) => r.success).length;
        const totalCount = results.length;

        resultDiv.className =
          successCount === totalCount ? "result success" : "result error";
        resultDiv.textContent = `📊 テスト結果: ${successCount}/${totalCount} 成功

${results
  .map(
    (r) =>
      `${r.success ? "✅" : "❌"} ${r.endpoint}
   ステータス: ${r.status} ${r.statusText}
   レスポンス時間: ${r.responseTime}ms`
  )
  .join("\n\n")}`;
      }

      // ページ読み込み時に基本情報を表示
      window.onload = function () {
        console.log("🚀 API テストページが読み込まれました");
        console.log("📍 ベースURL:", BASE_URL);
      };
    </script>
  </body>
</html>
